### Проект 04: Противоугонная сигнализация

![Img](./media/4-0.jpg)

#### 1. Описание

Противоугонная сигнализация состоит из PIR-датчика движения, зуммера, светодиода и основной платы kidsIOT. При программировании в KidsBlock можно определять, есть ли движение, считывая цифровой сигнал, полученный с PIR-датчика движения. Если кто-то движется, зуммер подаёт сигнал тревоги, а светодиод начинает мигать, предупреждая пользователя о том, что кто-то вошёл в зону. Таким образом можно реализовать недорогую противоугонную систему, подходящую для дома или офиса.



#### 2. Компоненты

|![Img](./media/A1.png)|![Img](./media/A4.png)|![Img](./media/A10.png)|![Img](./media/A14.png)|
| :--: | :--: | :--: | :--: |
|Основная плата kidsIOT×1|PIR-датчик движения×1|Пассивный зуммер×1|Серводвигатель×1|
|![Img](./media/A21.png)|![Img](./media/A19.png)|![Img](./media/A31.png)|  |
|Провода×2|USB-кабель×1| Anti-theft Alarm System LEGO Pieces×1 |  |

![Img](./media/4-1.png)

#### 3. Шаги сборки

##### Шаг 1：Необходимые компоненты

![Img](./media/Z-4-1.png)

##### Шаг 2：Процесс

Процесс 1：

![Img](./media/Z-4-2.png)

Процесс 2：

![Img](./media/Z-4-3.png)

Процесс 3：

![Img](./media/Z-4-4.png)

Процесс 4：

![Img](./media/Z-4-5.png)

Процесс 5：

![Img](./media/Z-4-6.png)

Процесс 6：Инициализация угла сервопривода

Подключение сервопривода (так же, как в проекте 03)

![Img](./media/Z-4-7.png)

Сначала напишите следующий код в программе KidsBlock и загрузите его в основную плату kidsIOT — затем сервопривод повернётся на 180° . (<span style="color: rgb(255, 76, 65);">Примечание: если сервопривод не может повернуться, нажмите кнопку RESET на плате kidsIOT.</span>)

![Img](./media/Z-4-8.png)

Процесс 7：(Разместите три Lego box на одной стороне, затем соберите четыре шестерни.)

![Img](./media/Z-4-9.png)

Процесс 8：

![Img](./media/Z-4-10.png)

Процесс 9：

![Img](./media/Z-4-11.png)

Процесс 10：

![Img](./media/Z-4-12.png)

Готово 1：

![Img](./media/Z-4-13.png)

Процесс 11：Используйте LEGO-плату из проекта 03

![Img](./media/Z-4-14.png)

Готово 2：

![Img](./media/Z-4-15.png)


#### 4. Схема подключения

| Module |kidsIOT Mainboard |
| :--: | :--: |
| PIR Motion Sensor |No.4 port（control pin is io27） |
|Passive Buzzer|No.6 port（control pin is io23）|
|Servo|G/V/io33 port（Brown→G，Red→V，Orange→io33）|

Подключите основную плату kidsIOT к компьютеру через USB-кабель.

![Img](./media/4-2.png)

#### 5. Пассивный зуммер издаёт звук

![Img](./media/4-3.png)

##### Метод 1

###### (1). Теория

Пассивный зуммер управляется прямоугольными импульсами. Давайте смоделируем прямоугольную волну ниже.
Высокий и низкий уровни на пине могут имитировать прямоугольную волну: удержание высокого уровня 1000us и низкого уровня 1000us может заставить зуммер звучать.

![Img](./media/4-4.png)

Изменяя длительности высокого и низкого уровней, можно изменить громкость/высоту звука. Попробуйте 1500us, 2000us, 3000us…

###### (2). Напишите программу

① Инициализируйте пин зуммера **IO23** в режиме "**Output**".

![Img](./media/4-5.png)

② Установите пин зуммера **IO23** в состояния "**High**" и "**Low**". Здесь берём задержку 0.001 секунды (1000 микросекунд) как пример, чтобы зуммер издавал звук.

![Img](./media/4-6.png)

Функция задержки — это задержка в микросекундах, то есть время задержки составляет 1000 микросекунд.

<span style="color: rgb(255, 76, 65);">Примечание: соотношение между секундами, миллисекундами и микросекундами: 1 секунда = 1000 миллисекунд = 1000000 микросекунд. </span>


По формуле f=1/T, при смене высокого и низкого уровней каждые 1000us получаем, что частота такой прямоугольной волны — 1000Hz (то есть число смен высокого/низкого уровня в секунду равно 1000).

③ Полная программа

![Img](./media/4-7.png)

###### (3). Результат тестирования

Нажмите![Img](./media/1-27.png) чтобы загрузить приведённый полный код в основную плату kidsIOT. После подачи питания через USB-кабель пассивный зуммер будет издавать звук.

##### Метод 2

###### (1). Теория

Используйте блок кода "passive buzzer" для управления.
Блок "passive buzzer" может генерировать PWM-сигнал фиксированной частоты для управления пассивным зуммером. Длительность звучания (beat) и частота звучания управляются параметрами.

![Img](./media/4-9.png)

###### (2). Добавьте “passive buzzer” 

Нажмите модуль “Actuator” в разделе “Extension” , затем выберите “**<span style="color: rgb(255, 76, 65);">esp32 Passive buzzer</span>**” и нажмите ![Img](media/781.png)чтобы вернуться к интерфейсу программирования.

![Img](./media/3-13.png)

![Img](./media/4-13.png)

![Img](./media/4-14.png)

###### (3). Описание блока

![Img](./media/4-9.png)

Задайте частоту и beat пассивного зуммера для указанного пина.

![Img](./media/4-16.png)
Задайте пассивному зуммеру проигрывать определённую музыку на указанном пине.

![Img](./media/4-17.png)

Задайте пассивному зуммеру не издавать звук на указанном пине.

###### (4). Напишите программу

① Инициализируйте пин зуммера **IO23** в режиме "**Output**".

![Img](./media/4-5.png)

② Установите пин звучания, частоту и beat — значения можно выбрать самостоятельно.

![Img](./media/4-19.png)

③ Получите разные тоны.

![Img](./media/4-20.png)

④ Полная программа

![Img](./media/4-21.png)

###### (5). Результат тестирования

Нажмите![Img](./media/1-27.png) чтобы загрузить приведённый полный код в основную плату kidsIOT. После подачи питания через USB-кабель пассивный зуммер будет издавать звуки разных тонов.

#### 6. Пассивный зуммер проигрывает музыку

![Img](./media/4-23.png)

###### (1). Напишите программу
① Пин зуммера — <span style="color: rgb(255, 76, 65);">**IO23**</span>, затем выберите мелодию (здесь для примера берём **Birthday**) .

![Img](./media/4-24.png)

② Полная программа

![Img](./media/4-25.png)

###### (2). Результат тестирования

Нажмите![Img](./media/1-27.png) чтобы загрузить приведённый полный код в основную плату kidsIOT. После подачи питания через USB-кабель пассивный зуммер проиграет мелодию "Happy Birthday" music.



#### 7. Считывание значения PIR-датчика движения

![Img](./media/4-27.png)

###### Step 1：Напишите программу

① Установите скорость (baud rate) 15200.

![Img](./media/1-68.png)

② Установите пин IO27, подключённый к PIR-датчику движения, в режим "**input**".

![Img](./media/4-29.png)

③ Определите глобальную переменную "<span style="color: rgb(255, 76, 65);">PIR_motion_sensor</span>" для хранения значения датчика.

![Img](./media/4-30.png)

④ Сохраните считанное значение датчика в переменную <span style="color: rgb(255, 76, 65);">"PIR_motion_sensor</span>" и выведите его в последовательный порт.

![Img](./media/4-31.png)

⑤ Полная программа

![Img](./media/4-32.png)

###### Step 2：Результат тестирования

Нажмите![Img](./media/1-27.png) чтобы загрузить приведённый полный код в основную плату kidsIOT. После подачи питания через USB-кабель нажмите ![Img](./media/1-87.png) в мониторе порта и установите скорость 15200. 

Когда датчик обнаруживает движение человека или животного, окно монитора порта выводит 1, и красный светодиод на датчике будет выключен; иначе монитор выводит 0, и красный светодиод на датчике будет включён.

<span style="color: rgb(255, 76, 65);">Примечание: датчик не обладает «проникающей» способностью. При обнаружении движения человека не закрывайте его.</span>


![Img](./media/4-35.png)

#### 8. Противоугонная сигнализация

![Img](./media/4-36.png)

##### (1). Шаги программирования

###### Step 1：Блок-схема

![Img](./media/4-37.png)

###### Step 2：Напишите программу

①Установите скорость 15200, пин IO27 PIR motion sensor — в режим "**input**".

![Img](./media/4-29.png)

② Установите пин IO33, подключённый к сервоприводу, в режим "**Output**", инициализируйте управляющий канал сервопривода как CH2 (LT1) и начальный угол как <span style="color: rgb(255, 76, 65);" >90°</span>, задержка 0.5 секунды.

![Img](./media/4-39.png)

② Определите глобальную переменную "<span style="color: rgb(255, 76, 65);">PIR_motion_sensor</span>" для хранения значения PIR-датчика движения.

![Img](./media/4-40.png)

③ Сохраните считанное значение датчика в переменную <span style="color: rgb(255, 76, 65);">"PIR_motion_sensor</span>".

![Img](./media/4-41.png)

④ Определите, обнаружил ли датчик движение человека или животного. Когда человек или животное движется, зуммер звучит, сервопривод поворачивается, чтобы закрыть дверь, а монитор порта выводит "Someone"; иначе зуммер не звучит, сервопривод поворачивается, чтобы открыть дверь, а монитор выводит " No one".

![Img](./media/4-42.png)

⑤ Полная программа

![Img](./media/4-43.png)

##### (2). Результат тестирования

Нажмите![Img](./media/1-27.png) чтобы загрузить приведённый полный код в основную плату kidsIOT. После подачи питания через USB-кабель нажмите ![Img](./media/1-87.png) в мониторе порта и установите скорость 15200. 

Когда датчик обнаруживает, что кто-то (человек или животное) движется, зуммер звучит, сервопривод поворачивается, чтобы закрыть дверь, а монитор порта выводит "Someone"; иначе зуммер не звучит, сервопривод поворачивается, чтобы открыть дверь, а монитор порта выводит "No one".

![Img](./media/4-46.png)

![Img](./media/4-47.jpg)

#### 9. Частые проблемы　

##### Q1: Тон пассивного зуммера не соответствует реальному тону?

A: Тоны, имитируемые обычными пассивными зуммерами, не могут удовлетворить требования профессионально точных тонов. Если нужны точные тоны, требуется более профессиональный пассивный зуммер.

##### Q2: PIR-датчик движения даёт ложные срабатывания?

A: ① Непрофессиональный PIR-датчик движения.

② Требования, чтобы избегать ложных срабатываний:
В пределах зоны обнаружения избегайте объектов, колеблемых ветром, таких как занавески, одежда, цветы и т.п.
Избегайте помех от яркого света в зоне обнаружения — солнечного света, фар автомобилей, прожекторов, освещения и других источников света.
